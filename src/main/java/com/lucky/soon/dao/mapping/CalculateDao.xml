<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lucky.soon.dao.CalculateDao">
	<sql id="order_number_base">
        id, rs1, rs2, rs3, rs4, rs5, rs6, rs7, create_date AS createDate, order_number AS orderNumber
    </sql>

	<sql id="result_base">
		id, content_system AS contentSystem, content_actual AS contentActual,
		count_system AS countSystem, count_actual AS countActual, unit_price AS unitPrice,
        total_system AS totalSystem, total_actual AS totalActual, total_result_system AS totalResultSystem,
        total_result_actual AS totalResultActual, create_date AS createDate, order_number AS orderNumber
	</sql>

	<select id="test" resultType="com.lucky.soon.model.EachResult">
		SELECT
		<include refid="order_number_base"/>
		FROM
		each_result
	</select>

	<!--获取最后三期的数据-->
	<select id="getThreeResultByDesc" resultType="com.lucky.soon.model.EachResult">
		SELECT
		<include refid="order_number_base"/>
		FROM
		each_result
		ORDER BY
		create_date DESC
		LIMIT 4
	</select>

	<!--根据tm获取num-->
	<select id="getNumBy7Result" resultType="Integer">
		SELECT
		n.num AS num
		FROM
		num_animal n
		INNER JOIN
		(
		SELECT
		n_.animal_id AS animal_id,
		n_.start_date AS start_date,
		n_.end_date AS end_date
		FROM
		num_animal n_
		WHERE
		n_.start_date &lt; #{date}
		AND
		n_.end_date &gt; #{date}
		AND
		n_.num IN
		<foreach collection="_7ResultList" item="item" open="(" close=")" separator=",">
			#{item}
		</foreach>
		) n_o
		ON
		n_o.animal_id = n.animal_id
		AND n_o.start_date = n.start_date
		AND n_o.end_date = n.end_date
		ORDER BY
		num
	</select>

	<!--插入result-->
	<insert id="insertResult">
		INSERT
		INTO
			result
			(
				content_system,
				create_date,
				order_number,
				count_system
			)
		VALUES
		(
			#{content_system},
			#{date},
			#{orderNumber},
			#{count_system}
		)
    </insert>

	<!--更新result-->
	<update id="updateResult">
        UPDATE
            result
        SET
            content_system = #{content_system},
            count_system = #{count_system}
        WHERE
            create_date = #{date}
        AND order_number = #{orderNumber}
    </update>

	<!--判断该日期、期数下是否有数据-->
	<select id="getResultByDateAndOrderNumber" resultType="com.lucky.soon.model.Result">
        SELECT
		<include refid="result_base"/>
        FROM
            result
        WHERE
            create_date = #{date}
        AND order_number = #{orderNumber}
    </select>

	<!--buy num-->
	<update id="updateResultForBuyNum">
		UPDATE
			result
		SET
			content_actual = #{content_actual},
			count_actual = #{count_actual},
			unit_price = #{price},
			total_system = count_system * #{price},
			total_actual = #{count_actual} * #{price}
		WHERE
			create_date = #{date}
        AND order_number = #{orderNumber}
	</update>

	<!--删除每期记录-->
	<delete id="deleteEachResultByDateAndOrderNumber">
		DELETE
		FROM
			each_result
		WHERE
			create_date = #{date}
        AND order_number = #{orderNumber}
	</delete>

	<!--insert each result-->
	<insert id="insertEachResult">
		INSERT
		INTO
			each_result
			(
				rs1,
				rs2,
				rs3,
				rs4,
				rs5,
				rs6,
				rs7,
				create_date,
				order_number
			)
			VALUES
			(
				#{eachResult.rs1},
				#{eachResult.rs2},
				#{eachResult.rs3},
				#{eachResult.rs4},
				#{eachResult.rs5},
				#{eachResult.rs6},
				#{eachResult.rs7},
				#{date},
				#{orderNumber}
			)
	</insert>

	<!--update result-->
	<update id="updateResultForCalculate" parameterType="com.lucky.soon.model.Result">
		UPDATE
			result
		SET
			odds = #{result.odds},
			total_result_system = #{result.totalResultSystem},
			total_result_actual = #{result.totalResultActual}
		WHERE
			create_date = #{result.createDate}
		AND order_number = #{result.orderNumber}
	</update>

</mapper>